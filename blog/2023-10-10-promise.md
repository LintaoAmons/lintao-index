# Promiseçš„executorå‡½æ•°å’ŒçŠ¶æ€

## new Promise çš„æ—¶å€™ï¼Œ Promise å°±å·²ç»å¼€å§‹è·‘äº†å—ï¼Ÿ

ğŸ¤–:
æ˜¯çš„ï¼Œå½“ä½ åˆ›å»ºä¸€ä¸ªæ–°çš„Promiseæ—¶ï¼Œå®ƒä¼šç«‹å³å¼€å§‹æ‰§è¡Œã€‚Promiseæ„é€ å‡½æ•°æ¥å—ä¸€ä¸ªexecutorå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šç«‹å³æ‰§è¡Œã€‚è¿™ä¸ªexecutorå‡½æ•°æ¥å—ä¸¤ä¸ªå‚æ•°ï¼šresolveå’Œrejectï¼Œå®ƒä»¬è¢«ç”¨æ¥æ”¹å˜Promiseçš„çŠ¶æ€ã€‚

è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œæ¼”ç¤ºäº†Promiseæ˜¯å¦‚ä½•ç«‹å³æ‰§è¡Œçš„ï¼š

```javascript
let p = new Promise((resolve, reject) => {
    console.log('Promise is running');
    resolve();
});

console.log('After creating the Promise');
```

è¿è¡Œè¿™æ®µä»£ç ï¼Œä½ å°†ä¼šçœ‹åˆ°"Promise is running"å…ˆäº"After creating the Promise"æ‰“å°å‡ºæ¥ï¼Œè¿™è¯æ˜äº†Promiseåœ¨åˆ›å»ºæ—¶å°±å¼€å§‹è¿è¡Œäº†ã€‚

## resolve åé¢çš„ä»£ç ä¼šç»§ç»­è·‘å—ï¼Ÿ

```javascript
let p = new Promise((resolve, reject) => {
    console.log('Promise is running');
    resolve();
    // highlight-next-line
    console.log('Promise is running2');
});

console.log('After creating the Promise');
```

Promise is running2 ä¼šè·‘å—ï¼Ÿ

ğŸ¤–:
æ˜¯çš„ï¼Œ"Promise is running2" è¿™æ®µä»£ç ä¼šæ‰§è¡Œã€‚å½“ä½ åœ¨Promiseçš„executorå‡½æ•°ä¸­è°ƒç”¨resolve()æˆ–reject()æ–¹æ³•åï¼Œå…¶ä»–ä»£ç è¿˜ä¼šç»§ç»­æ‰§è¡Œï¼Œç›´åˆ°executorå‡½æ•°ç»“æŸã€‚ä½†æ˜¯ï¼Œä¸€æ—¦Promiseçš„çŠ¶æ€è¢«resolve()æˆ–reject()æ”¹å˜ï¼Œå®ƒå°±ä¸èƒ½å†æ”¹å˜äº†ã€‚

æ‰€ä»¥åœ¨ä½ çš„ç¤ºä¾‹ä¸­ï¼Œconsole.log('Promise is running2'); è¿™æ®µä»£ç ä¼šåœ¨ resolve(); åæ‰§è¡Œï¼Œç„¶åæ‰“å° "Promise is running2"ã€‚

ä½†æ˜¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™å¹¶ä¸ä¼šæ”¹å˜Promiseçš„çŠ¶æ€ï¼Œresolve();å·²ç»å°†Promiseçš„çŠ¶æ€è®¾ç½®ä¸ºfulfilledï¼Œä»¥åçš„ä»»ä½•resolve()æˆ–reject()è°ƒç”¨éƒ½ä¸ä¼šæ”¹å˜Promiseçš„çŠ¶æ€ã€‚

ä»¥ä¸‹æ˜¯ä½ çš„ä»£ç çš„è¿è¡Œç»“æœï¼š

```
Promise is running
Promise is running2
After creating the Promise
```

è¿™ç¡®è®¤äº† "Promise is running2" è¿™æ®µä»£ç ç¡®å®è¢«æ‰§è¡Œäº†ã€‚


## å³ä½¿å†è°ƒç”¨reject éƒ½ä¸ä¼šå†æ”¹å˜äº†å—ï¼Ÿ

ğŸ¤–:
æ˜¯çš„ï¼Œä¸€æ—¦Promiseçš„çŠ¶æ€è¢«æ”¹å˜ï¼ˆæ— è®ºæ˜¯é€šè¿‡resolve()è®¾ä¸ºfulfilledè¿˜æ˜¯é€šè¿‡reject()è®¾ä¸ºrejectedï¼‰ï¼Œå®ƒå°±ä¼šæ°¸ä¹…ä¿æŒè¿™ä¸ªçŠ¶æ€ï¼Œä¸èƒ½å†è¢«æ”¹å˜ã€‚è¿™å°±æ˜¯æ‰€è°“çš„Promiseçš„â€œå·²å®šå‹â€ï¼ˆsettledï¼‰ç‰¹æ€§ã€‚

è¿™æ„å‘³ç€ï¼Œå¦‚æœä½ åœ¨ä¸€ä¸ªPromiseçš„executorå‡½æ•°ä¸­é¦–å…ˆè°ƒç”¨äº†resolve()ï¼Œç„¶ååˆè°ƒç”¨äº†reject()ï¼Œé‚£ä¹ˆreject()å°†ä¸ä¼šæœ‰ä»»ä½•æ•ˆæœã€‚Promiseçš„çŠ¶æ€å·²ç»åœ¨resolve()è¢«è°ƒç”¨æ—¶è®¾ä¸ºäº†fulfilledï¼Œåç»­çš„reject()è°ƒç”¨ä¸èƒ½å†æ”¹å˜è¿™ä¸ªçŠ¶æ€ã€‚

åŒæ ·çš„ï¼Œå¦‚æœä½ é¦–å…ˆè°ƒç”¨äº†reject()ï¼Œç„¶ååˆè°ƒç”¨äº†resolve()ï¼Œé‚£ä¹ˆresolve()ä¹Ÿä¸ä¼šæœ‰ä»»ä½•æ•ˆæœã€‚

è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š

```javascript
let p = new Promise((resolve, reject) => {
    resolve('first resolve');
    // highlight-next-line
    reject('then reject'); // This will have no effect
});

p.then(value => console.log('Resolved with ' + value))
 .catch(reason => console.log('Rejected with ' + reason));

// Outputs: "Resolved with first resolve"
```

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œå°½ç®¡reject()è¢«è°ƒç”¨äº†ï¼Œä½†Promiseä»ç„¶ä»¥resolve()è°ƒç”¨ä¸­çš„å€¼fulfilledï¼Œå› ä¸ºè¿™æ˜¯é¦–ä¸ªæ”¹å˜PromiseçŠ¶æ€çš„è°ƒç”¨ã€‚catch()å›è°ƒå‡½æ•°å¹¶æœªè¢«æ‰§è¡Œï¼Œå› ä¸ºPromiseå¹¶æœªè¢«rejectã€‚

## resolve å‡½æ•°å’Œ reject  å‡½æ•°æ¥å—çš„å‚æ•°å€¼ä¼šä½œä¸ºthenå‡½æ•°æˆ–è€…catchå‡½æ•°çš„å…¥å‚ï¼Ÿ

ğŸ¤–:
æ˜¯çš„ï¼Œä½ å®Œå…¨æ­£ç¡®ã€‚å½“ä½ è°ƒç”¨Promiseçš„resolveå‡½æ•°æˆ–è€…rejectå‡½æ•°æ—¶ï¼Œä½ ä¼ é€’ç»™è¿™ä¸¤ä¸ªå‡½æ•°çš„å‚æ•°å°†ä¼šè¢«ç”¨ä½œ.then()æˆ–è€….catch()å›è°ƒå‡½æ•°çš„å‚æ•°ã€‚

å¯¹äºresolve()å‡½æ•°æ¥è¯´ï¼Œä½ ä¼ ç»™å®ƒçš„å‚æ•°å°†ä½œä¸º.then()å›è°ƒå‡½æ•°çš„å‚æ•°ã€‚ä¾‹å¦‚ï¼š

```javascript
let p = new Promise((resolve, reject) => {
    resolve('Hello, Promise!');
});

p.then(value => console.log(value)); // Outputs: "Hello, Promise!"
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå­—ç¬¦ä¸²'Hello, Promise!'è¢«ä¼ é€’ç»™äº†resolve()å‡½æ•°ï¼Œç„¶åå®ƒè¢«ç”¨ä½œäº†.then()å›è°ƒå‡½æ•°çš„å‚æ•°ã€‚

å¯¹äºreject()å‡½æ•°æ¥è¯´ï¼Œä½ ä¼ ç»™å®ƒçš„å‚æ•°å°†ä½œä¸º.catch()å›è°ƒå‡½æ•°çš„å‚æ•°ã€‚ä¾‹å¦‚ï¼š

```javascript
let p = new Promise((resolve, reject) => {
    reject('Oops, something went wrong');
});

p.catch(reason => console.log(reason)); // Outputs: "Oops, something went wrong"
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå­—ç¬¦ä¸²'Oops, something went wrong'è¢«ä¼ é€’ç»™äº†reject()å‡½æ•°ï¼Œç„¶åå®ƒè¢«ç”¨ä½œäº†.catch()å›è°ƒå‡½æ•°çš„å‚æ•°ã€‚

è¿™å°±æ˜¯Promiseçš„åŸºæœ¬å·¥ä½œåŸç†ï¼šresolve()å‡½æ•°å’Œreject()å‡½æ•°æ§åˆ¶Promiseçš„çŠ¶æ€ï¼Œå¹¶å°†å€¼æˆ–åŸå› ä¼ é€’ç»™åç»­çš„.then()æˆ–.catch()å›è°ƒå‡½æ•°ã€‚

## Promise typescript æ–¹æ³•ç­¾å

```ts
then<TResult1 = T, TResult2 = never>(
    onfulfilled?: ((value: T) => TResult1 | PromiseLike<TResult1>) | undefined | null,
    onrejected?: ((reason: any) => TResult2 | PromiseLike<TResult2>) | undefined | null
): Promise<TResult1 | TResult2>;
```

è¿™æ˜¯å¯¹Promiseçš„`.then()`æ–¹æ³•åœ¨TypeScriptä¸­çš„ç±»å‹å®šä¹‰ã€‚æˆ‘å°†ä¸€æ­¥æ­¥è§£æï¼š

- `then<TResult1 = T, TResult2 = never>`: `then` æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œæ¥å—ä¸¤ä¸ªç±»å‹å‚æ•° `TResult1` å’Œ `TResult2`ã€‚å¦‚æœæœªæä¾›ï¼Œ`TResult1` é»˜è®¤ä¸º Promise è§£æå€¼çš„åŒä¸€ç±»å‹ï¼ˆ`T`ï¼‰ï¼Œ`TResult2` é»˜è®¤ä¸º `never`ï¼Œè¿™æ˜¯ä¸€ä¸ªä»£è¡¨æ°¸ä¸å‡ºç°çš„å€¼çš„ç±»å‹ã€‚

- `(onfulfilled?: ((value: T) => TResult1 | PromiseLike<TResult1>) | undefined | null)`: `then` çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå¯é€‰çš„ `onfulfilled` å‡½æ•°ã€‚å½“ Promise è§£å†³æ—¶ï¼Œå°†è°ƒç”¨æ­¤å‡½æ•°ï¼Œå¹¶æ¥æ”¶å·²è§£å†³çš„å€¼ï¼ˆ`value: T`ï¼‰ã€‚æ­¤å‡½æ•°å¯ä»¥è¿”å›ç±»å‹ `TResult1` çš„å€¼æˆ–è§£æä¸º `TResult1` çš„ PromiseLike å¯¹è±¡ã€‚å¦‚æœæœªæä¾›æ­¤å‡½æ•°ï¼Œæˆ–è€…å€¼ä¸º`undefined` æˆ– `null`ï¼ŒTypeScript ä»ç„¶å…è®¸è°ƒç”¨ `then` æ–¹æ³•ã€‚

- `(onrejected?: ((reason: any) => TResult2 | PromiseLike<TResult2>) | undefined | null)`: `then` çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå¯é€‰çš„ `onrejected` å‡½æ•°ã€‚å½“ Promise è¢«æ‹’ç»æ—¶ï¼Œå°†è°ƒç”¨æ­¤å‡½æ•°ï¼Œå¹¶æ¥æ”¶æ‹’ç»åŸå› (`reason: any`)ã€‚æ­¤å‡½æ•°å¯ä»¥è¿”å›ç±»å‹ `TResult2` çš„å€¼æˆ–è§£æä¸º `TResult2` çš„ PromiseLike å¯¹è±¡ã€‚å¦‚æœæœªæä¾›æ­¤å‡½æ•°ï¼Œæˆ–è€…å€¼ä¸º `undefined` æˆ– `null`ï¼ŒTypeScript ä»ç„¶å…è®¸è°ƒç”¨ `then` æ–¹æ³•ã€‚

- `: Promise<TResult1 | TResult2>`: `then` è¿”å›ä¸€ä¸ªæ–°çš„ Promiseã€‚æ–° Promise çš„è§£æå€¼çš„ç±»å‹å¯ä»¥æ˜¯ `TResult1` æˆ– `TResult2`ï¼Œå–å†³äºåŸå§‹ Promise æ˜¯è§£å†³è¿˜æ˜¯æ‹’ç»ï¼Œä»¥åŠ `onfulfilled` æˆ– `onrejected` å‡½æ•°è¿”å›ä»€ä¹ˆã€‚

ç®€å•æ¥è¯´ï¼Œ`.then()` å…è®¸ä½ æŒ‡å®šå½“ä¸€ä¸ª Promise è§£ææˆ–æ‹’ç»æ—¶å‘ç”Ÿä»€ä¹ˆï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ Promiseï¼Œä½¿ä½ èƒ½å¤Ÿå°†å¼‚æ­¥æ“ä½œé“¾æ¥åœ¨ä¸€èµ·ã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œå±•ç¤ºäº†åœ¨ `.then()` æ–¹æ³•ä¸­å¦‚ä½•ä½¿ç”¨ `TResult1` å’Œ `TResult2`ï¼š

```typescript
let promise: Promise<number> = new Promise((resolve, reject) => {
  let success = false; // æ”¹ä¸º true æ¥è§£æ Promise
  if (success) {
    resolve(123);
  } else {
    reject('å‡ºé”™äº†');
  }
});

promise.then<number, string>(
  (value: number) => { console.log(value); return value; }, // å¦‚æœ Promise è§£æï¼Œå°†ä¼šè°ƒç”¨æ­¤å‡½æ•°
  (error: any) => { console.log(error); return error; }    // å¦‚æœ Promise è¢«æ‹’ç»ï¼Œå°†ä¼šè°ƒç”¨æ­¤å‡½æ•°
);
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`TResult1` æ˜¯ `number` ç±»å‹ï¼Œå¯¹åº”è§£æå€¼ï¼Œ`TResult2` æ˜¯ `string` ç±»å‹ï¼Œå¯¹åº”æ‹’ç»çš„åŸå› ã€‚
ç„¶è€Œï¼Œä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬åªåœ¨`.then()`æ–¹æ³•ä¸­å¤„ç†resolvedçŠ¶æ€ï¼Œè€Œåœ¨`.catch()`æ–¹æ³•ä¸­å¤„ç†rejectedçŠ¶æ€ï¼Œè¿™æ ·ä»£ç æ›´æ˜“è¯»ï¼Œæ›´æ˜“äºç†è§£ã€‚

## ä¸ºäº†å±•ç¤º reject çš„ reason å¯ä»¥æ˜¯ any ç±»å‹ï¼Œè€Œå¹¶é TResult2 ç±»å‹ï¼Œä¼˜åŒ–ä½ åˆšæ‰çš„ä¾‹å­

ğŸ¤–:
å½“ç„¶ï¼Œè¿™æ˜¯ä¸€ä¸ªä¼˜åŒ–åçš„ä¾‹å­ï¼Œå±•ç¤ºäº†æ‹’ç»çš„åŸå› å¯ä»¥æ˜¯`any`ç±»å‹ï¼š

```typescript
let promise: Promise<number> = new Promise((resolve, reject) => {
  let success = false; // æ”¹ä¸º true æ¥è§£æ Promise
  if (success) {
    resolve(123);
  } else {
    reject({message: 'å‡ºé”™äº†', code: 500}); // æ‹’ç»çš„åŸå› ç°åœ¨æ˜¯ä¸€ä¸ªå¯¹è±¡
  }
});

promise.then<number, string>(
  (value: number) => { console.log(value); return value.toString(); }, // å¦‚æœ Promise è§£æï¼Œå°†ä¼šè°ƒç”¨æ­¤å‡½æ•°
  (error: any) => { console.log(error); return JSON.stringify(error); }    // å¦‚æœ Promise è¢«æ‹’ç»ï¼Œå°†ä¼šè°ƒç”¨æ­¤å‡½æ•°
);
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘å°†æ‹’ç»çš„åŸå› æ”¹ä¸ºäº†ä¸€ä¸ªå¯¹è±¡ `{message: 'å‡ºé”™äº†', code: 500}`ã€‚è¿™ä¸ªå¯¹è±¡èƒ½å¤Ÿè¢«æˆåŠŸåœ°ä¼ é€’ç»™`onrejected`å‡½æ•°ï¼Œå°½ç®¡`TResult2`åœ¨æ­¤å¤„è¢«å®šä¹‰ä¸º`string`ç±»å‹ï¼Œä½†æ˜¯è¿™å¹¶ä¸ä¼šå½±å“æˆ‘ä»¬æ‹’ç»Promiseæ—¶ä¼ é€’ä»»ä½•ç±»å‹çš„åŸå› ã€‚å› æ­¤ï¼Œ`onrejected`å‡½æ•°æ¥æ”¶åˆ°çš„`error`æ˜¯`any`ç±»å‹ã€‚

ç„¶åï¼Œæˆ‘ä»¬å°†è¿™ä¸ªå¯¹è±¡è½¬æ¢ä¸ºå­—ç¬¦ä¸²è¿”å›ï¼Œå› æ­¤ï¼Œè¿”å›çš„æ–°Promiseå°†è§£æä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¿™ä¸`TResult2`çš„ç±»å‹ç›¸åŒ¹é…ã€‚


